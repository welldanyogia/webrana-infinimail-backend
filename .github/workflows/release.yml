name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  GO_VERSION: '1.24'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is-prerelease: ${{ steps.check-prerelease.outputs.is-prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"

      - name: Check if pre-release
        id: check-prerelease
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a pre-release version"
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: Validate semantic version
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)\.[0-9]+)?$ ]]; then
            echo "ERROR: Invalid semantic version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-{alpha|beta|rc}.N"
            exit 1
          fi
          echo "Version format is valid"

  run-tests:
    name: Run Full Test Suite
    runs-on: ubuntu-latest
    needs: validate-tag
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: infinimail_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run all tests
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/infinimail_test?sslmode=disable
        run: |
          echo "Running unit tests..."
          go test -short -race ./...

          echo "Running integration tests..."
          go test -tags=integration -race ./tests/integration/...

          echo "Running E2E tests..."
          go test -tags=e2e -race ./tests/e2e/...

      - name: Run linter
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  build-and-push-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [validate-tag, run-tests]
    outputs:
      image-digest: ${{ steps.build-and-push.outputs.digest }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ needs.validate-tag.outputs.is-prerelease == 'false' }}

      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: validate-tag
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"* %s (%h)" --no-merges)
          else
            echo "Generating changelog from $PREVIOUS_TAG to ${{ github.ref_name }}"
            COMMITS=$(git log $PREVIOUS_TAG..${{ github.ref_name }} --pretty=format:"* %s (%h)" --no-merges)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -i "^* feat" || true)
          FIXES=$(echo "$COMMITS" | grep -i "^* fix" || true)
          DOCS=$(echo "$COMMITS" | grep -i "^* docs" || true)
          REFACTOR=$(echo "$COMMITS" | grep -i "^* refactor" || true)
          TESTS=$(echo "$COMMITS" | grep -i "^* test" || true)
          CHORES=$(echo "$COMMITS" | grep -i "^* chore" || true)
          OTHER=$(echo "$COMMITS" | grep -v -i "^* \(feat\|fix\|docs\|refactor\|test\|chore\)" || true)

          # Build changelog
          CHANGELOG="## What's Changed\n\n"

          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### Features\n${FEATURES}\n\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### Bug Fixes\n${FIXES}\n\n"
          fi

          if [ -n "$REFACTOR" ]; then
            CHANGELOG="${CHANGELOG}### Refactoring\n${REFACTOR}\n\n"
          fi

          if [ -n "$TESTS" ]; then
            CHANGELOG="${CHANGELOG}### Tests\n${TESTS}\n\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG="${CHANGELOG}### Documentation\n${DOCS}\n\n"
          fi

          if [ -n "$CHORES" ]; then
            CHANGELOG="${CHANGELOG}### Chores\n${CHORES}\n\n"
          fi

          if [ -n "$OTHER" ]; then
            CHANGELOG="${CHANGELOG}### Other Changes\n${OTHER}\n\n"
          fi

          # Save to file and output
          echo -e "$CHANGELOG" > changelog.md
          cat changelog.md

          # Set output (escape newlines for GitHub Actions)
          {
            echo 'changelog<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Upload changelog artifact
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.md

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-tag, run-tests, build-and-push-image, generate-changelog]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Read changelog
        id: read-changelog
        run: |
          CHANGELOG=$(cat changelog.md)
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create release notes
        id: release-notes
        run: |
          cat > release-notes.md <<EOF
          # Infinimail Backend ${{ github.ref_name }}

          ${{ steps.read-changelog.outputs.changelog }}

          ## Docker Image

          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-tag.outputs.version }}
          \`\`\`

          Image digest: \`${{ needs.build-and-push-image.outputs.image-digest }}\`

          ## Installation

          ### Using Docker Compose

          \`\`\`yaml
          services:
            backend:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-tag.outputs.version }}
              ports:
                - "8080:8080"
              environment:
                DATABASE_URL: postgres://user:pass@postgres:5432/infinimail
          \`\`\`

          ### Using Binary

          Download the appropriate binary for your platform from the assets below.

          ## Verification

          All releases pass our quality gates:
          - Unit tests with race detection
          - Integration tests with real database
          - End-to-end tests
          - Code coverage > 70%
          - Static analysis (golangci-lint)

          ## Support

          For issues, please visit: https://github.com/${{ github.repository }}/issues
          EOF

          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          draft: false
          prerelease: ${{ needs.validate-tag.outputs.is-prerelease == 'true' }}
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: Notify Release Success
    runs-on: ubuntu-latest
    needs: [validate-tag, create-release]
    if: success()
    steps:
      - name: Summary
        run: |
          echo "# Release Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ needs.validate-tag.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate-tag.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release available at: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify Release Failure
    runs-on: ubuntu-latest
    needs: [validate-tag, run-tests, build-and-push-image, create-release]
    if: failure()
    steps:
      - name: Summary
        run: |
          echo "# Release Failed :x:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
