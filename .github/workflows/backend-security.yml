name: Backend Security Scanning

on:
  push:
    branches: [main, develop]
    paths:
      - 'webrana-infinimail-backend/**'
      - '.github/workflows/backend-security.yml'
  pull_request:
    branches: [main]
    paths:
      - 'webrana-infinimail-backend/**'
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

defaults:
  run:
    working-directory: webrana-infinimail-backend

permissions:
  contents: read
  security-events: write

jobs:
  gosec:
    name: Gosec Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
          cache-dependency-path: webrana-infinimail-backend/go.sum

      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./...'
        continue-on-error: true
        env:
          GOPATH: /home/runner/go

      - name: Upload Gosec SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      - name: Run Gosec (JSON output for artifacts)
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt json -out gosec-report.json ./... || true

      - name: Upload Gosec JSON report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gosec-report
          path: webrana-infinimail-backend/gosec-report.json
          retention-days: 30

      - name: Parse Gosec results
        if: always()
        run: |
          if [ -f gosec-report.json ]; then
            echo "### Gosec Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            ISSUES=$(jq '.Stats.found // 0' gosec-report.json)
            echo "**Total Issues Found:** $ISSUES" >> $GITHUB_STEP_SUMMARY

            if [ "$ISSUES" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Issue Summary:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.Issues[] | "- [\(.severity)] \(.details) in \(.file):\(.line)"' gosec-report.json | head -20 >> $GITHUB_STEP_SUMMARY
            fi
          fi

  trivy-fs:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './webrana-infinimail-backend'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'
          category: trivy-fs

      - name: Run Trivy (table output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './webrana-infinimail-backend'
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.x'
          cache-dependency-path: webrana-infinimail-backend/go.sum

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > govulncheck-results.json || true

      - name: Upload govulncheck results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: govulncheck-report
          path: webrana-infinimail-backend/govulncheck-results.json
          retention-days: 30

      - name: Parse govulncheck results
        if: always()
        run: |
          echo "### Go Vulnerability Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f govulncheck-results.json ]; then
            VULNS=$(jq '[.finding // empty] | length' govulncheck-results.json)
            echo "**Vulnerabilities Found:** $VULNS" >> $GITHUB_STEP_SUMMARY

            if [ "$VULNS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Vulnerability Details:**" >> $GITHUB_STEP_SUMMARY
              jq -r '.finding // empty | "- \(.osv.id): \(.osv.summary)"' govulncheck-results.json >> $GITHUB_STEP_SUMMARY
            fi
          fi

  secrets-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # PLACEHOLDER: To be completed by SENTINEL
  advanced-security-scan:
    name: Advanced Security Scanning (Placeholder)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Placeholder for SENTINEL
        run: |
          echo "### Advanced Security Scanning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This section is reserved for SENTINEL to implement:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] SAST (Static Application Security Testing)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] DAST (Dynamic Application Security Testing)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] License compliance checking" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Container image hardening verification" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] API security testing" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] OWASP Top 10 vulnerability checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This is a placeholder. SENTINEL will complete this section." >> $GITHUB_STEP_SUMMARY

  # PLACEHOLDER: To be completed by SENTINEL
  compliance-check:
    name: Security Compliance Check (Placeholder)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Placeholder for SENTINEL
        run: |
          echo "### Security Compliance Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This section is reserved for SENTINEL to implement:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] CIS Benchmark compliance" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] PCI-DSS requirements" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] GDPR compliance checks" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Security policy enforcement" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Audit logging verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This is a placeholder. SENTINEL will complete this section." >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gosec, trivy-fs, dependency-check, secrets-scan]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "### Security Scanning Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Results:**" >> $GITHUB_STEP_SUMMARY
          echo "- Gosec: ${{ needs.gosec.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy Filesystem: ${{ needs.trivy-fs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets Scan: ${{ needs.secrets-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recommendations:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review all security findings in the Security tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Address CRITICAL and HIGH severity issues immediately" >> $GITHUB_STEP_SUMMARY
          echo "3. Update dependencies with known vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "4. Ensure no secrets are committed to the repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Advanced security scanning to be completed by SENTINEL" >> $GITHUB_STEP_SUMMARY
