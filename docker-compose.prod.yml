# Infinimail Production Docker Compose
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Run: docker compose -f docker-compose.prod.yml up -d --build

services:
  db:
    image: postgres:16-alpine
    container_name: infinimail-db
    restart: always
    environment:
      POSTGRES_USER: infinimail
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme_secure_password}
      POSTGRES_DB: infinimail
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - infinimail-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U infinimail"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: infinimail-backend
    restart: always
    environment:
      # Use staging to bypass SSL check for internal Docker network
      # This is safe because db is only accessible within Docker network
      APP_ENV: staging
      
      # Database - internal Docker network (no SSL needed)
      DATABASE_URL: postgres://infinimail:${DB_PASSWORD:-changeme_secure_password}@db:5432/infinimail?sslmode=disable
      
      # API Server
      API_PORT: 8081
      API_KEY: ${API_KEY:-}
      
      # CORS - Frontend domain
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-https://infinimail.webrana.id}
      
      # Rate Limiting
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      RATE_LIMIT_BURST: ${RATE_LIMIT_BURST:-20}
      
      # SMTP Server
      SMTP_PORT: 25
      SMTP_DOMAIN: ${SMTP_DOMAIN:-mail.infinimail.webrana.id}
      SMTP_ADDR: :25
      SMTP_ALLOW_INSECURE: "false"
      SMTP_MAX_MESSAGE_SIZE: 26214400
      SMTP_MAX_RECIPIENTS: 100
      
      # Storage
      ATTACHMENT_STORAGE_PATH: /app/attachments
      MAX_ATTACHMENT_SIZE: 26214400
      
      # Features
      AUTO_PROVISIONING_ENABLED: "true"
      
      # Logging
      LOG_LEVEL: info
    ports:
      - "8081:8081"
      - "25:25"
    volumes:
      - attachments_data:/app/attachments
    depends_on:
      db:
        condition: service_healthy
    networks:
      - infinimail-network

volumes:
  postgres_data:
  attachments_data:

networks:
  infinimail-network:
    driver: bridge
